#include "ti83plus.inc"
#define progStart $9D95
.org	progStart-2
.db	 $BB,$6D
; mirageos header
	xor a
	jr    nc,main
title:    .db    "APPINST",0
main:

	in a, (6)
	push af
	in a, (2)
	and 80h
	ld b, 15h
	jr z, loc_9DAA
	in a, (21h)
	and 3
	ld b, 69h ; 'i'
	jr nz, loc_9DAA
	ld b, 29h ; ')'

loc_9DAA:		 ; CODE XREF: RAM:9D9E↑j
			; RAM:9DA6↑j ...
	ld a, b
	cp 8
	jr c, errorHandler
	out (6), a
	ld hl, 4000h
	ld a, (hl)
	cp 0FFh
	jr z, loc_9DD5
	cp 80h
	jr nz, errorHandler
	push bc
	push hl
	ld a, b
	ld hl, 4000h
	ld de, 8080h
	bcall (_FindAppHeaderSubField)
	inc hl
	inc hl
	ld d, (hl)
	pop hl
	pop bc
	jr nz, errorHandler
	ld a, b
	sub d
	ld b, a
	jr loc_9DAA

loc_9DD5:		 ; CODE XREF: RAM:9DB7↑j
	pop af
	push af
	out (6), a
	push bc
	ld hl, aApp
	rst rMOV9TOOP1
	bcall (_ChkFindSym)
	inc de
	inc de
	ld (saveSScreen), de
	pop bc
	jr c, errorHandler
	ld a, b
	out (6), a
	ld hl, 4000h
	ld bc, 80h

loc_9DF3:		 ; CODE XREF: RAM:9E17↓j
	bit 7, h
	jr nz, errorHandler
	push hl
	push bc
	ld hl, (saveSScreen)
	ld de, 983Ah
	ldir
	pop bc
	pop hl
	push hl
	push bc
	push af
	ld (8434h), a
	call writeFlash
	ld hl, (saveSScreen)
	pop af
	pop bc
	add hl, bc
	ld (saveSScreen), hl
	pop hl
	add hl, bc
	jr loc_9DF3

errorHandler:
	pop af
	out (6), a
	ret

writeFlash:
;Writes C bytes to AHL
;Input: AHL is page:address
; pagedBuf contains data to write
	ld (arcInfo),a
	ld (iMathPtr5),hl
	ld a,c
	ld (pagedCount),a
	in a,(6)
	push af
	ld a,7Bh
	call translatePage
	out (6),a
	ld hl,5092h
	ld e,(hl)
	inc hl
	ld d,(hl)
	inc hl
	ld a,(hl)
	call translatePage
	out (6),a
	ex de,hl
	ld a,0CCh
	ld bc,0FFFFh
	cpir
	ld e,(hl)
	inc hl
	ld d,(hl)
	ex de,hl
	ld de,returnPoint
	push de
	jp (hl)
returnPoint:
	pop af
	out (6),a
	ret
translatePage:
	push af
	in a,(2)
	and 80h
	jr z,_old
	pop bc
	in a,(21h)
	and 3
	ld a,b
	ret nz
	and 3Fh
	ret
_old: 
	pop af
	and 1Fh
	ret
aApp:	 
	.db 15h
	.db "APP",0
